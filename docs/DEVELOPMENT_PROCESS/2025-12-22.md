# Development Log - December 22, 2025

## Summary

Fixed duplicate field names in `dataTableColumn` schema and implemented the new `dataTableView` table for managing multiple custom views per data table.

---

## Changes Made

### 1. Fixed Duplicate `format` Field in `dataTableColumn.ts`

**Issue**: The `config` JSONB had two `format` properties that would conflict:
- Line 42: `format?: 'date' | 'datetime' | 'time'` (for Date/DateTime fields)
- Line 67: `format?: 'hex' | 'rgb' | 'hsl'` (for Color fields)

**Solution**: Renamed to field-specific names:
- `dateFormat` for date/datetime fields
- `colorFormat` for color fields

**File**: `server/db/schema/dataTableColumn.ts`

---

### 2. Created New `dataTableView` Schema

**Purpose**: Separate view configuration from table structure to enable:
- Multiple custom views per table (like Airtable/Notion)
- Per-view filtering, sorting, and column visibility
- Different view types (table, kanban, calendar, gantt, gallery)
- User-created custom views

**Key Design Decisions**:

1. **Row Presentation vs Data Views**:
   - `formJson`, `cardJson`, `listJson`, `dashboardJson` remain on `dataTable` (define how individual rows are displayed)
   - `dataTableView` is for filtering, sorting, and viewing the dataset itself

2. **Multiple Sort Support**: `sort` is an array to support multi-level sorting
3. **Nested Filters**: `filters` support nested AND/OR conditions for complex queries
4. **View Types**: table, kanban, calendar, gantt, gallery
5. **Default View**: Auto-created when table is created

**File**: `server/db/schema/dataTableView.ts`

**Schema Structure**:
```typescript
{
  id: uuid
  dataTableId: uuid (FK to data_tables)
  name: text (e.g., "All Records", "Active Only")
  slug: text (URL-friendly)
  type: text (table | kanban | calendar | gantt | gallery)
  isDefault: boolean
  isPublic: boolean
  visibleColumns: jsonb (array of column IDs)
  columnWidths: jsonb (custom widths)
  filters: jsonb (nested AND/OR conditions)
  sort: jsonb (multiple sort criteria)
  viewConfig: jsonb (type-specific settings)
  pageSize: jsonb
  createdBy: uuid (FK to users)
  createdAt: timestamp
  updatedAt: timestamp
}
```

---

### 3. Auto-Populate Default View on Table Creation

**Implementation**: Modified table creation endpoint to automatically create a default "All Records" view.

**File**: `server/api/apps/[appSlug]/tables/index.post.ts`

**Changes**:
- Step 3: Capture column IDs from created columns
- Step 4: Create default view with:
  - Name: "All Records"
  - Slug: "all-records"
  - Type: "table"
  - isDefault: true
  - All columns visible by default
  - No filters or sorting
  - Default view config (row height, show row numbers)

---

### 4. Added Type Exports

**File**: `shared/types/db.ts`

Added type exports for the new schema:
```typescript
export type DataTableView = typeof dataTableViews.$inferSelect
export type NewDataTableView = typeof dataTableViews.$inferInsert
```

---

### 5. Created Migration File

**File**: `server/db/migrations/postgresql/0001_add_data_table_views.sql`

**Includes**:
1. Create `data_table_views` table
2. Add new columns to `data_table_columns`:
   - `default_value`
   - `is_unique`
   - `is_hidden`
   - `validation_rules`
3. Add foreign key constraints

---

### 6. Updated Database Reset Script

**File**: `server/api/db-reset.post.ts`

Added `data_table_views` to the drop tables list (in correct order to respect foreign keys).

---

## Database Schema Relationships

```
data_tables (1) ──< (many) data_table_views
data_tables (1) ──< (many) data_table_columns
data_table_views (many) >── (1) users (created_by)
```

---

## View Configuration Examples

### Table View
```json
{
  "type": "table",
  "visibleColumns": ["col1", "col2", "col3"],
  "sort": [
    { "columnId": "col1", "direction": "asc" },
    { "columnId": "col2", "direction": "desc" }
  ],
  "filters": {
    "operator": "AND",
    "conditions": [
      { "columnId": "status", "operator": "equals", "value": "active" }
    ]
  },
  "viewConfig": {
    "rowHeight": "default",
    "showRowNumbers": true
  }
}
```

### Kanban View
```json
{
  "type": "kanban",
  "viewConfig": {
    "groupByColumn": "status",
    "cardFields": ["title", "assignee", "due_date"],
    "cardCoverColumn": "cover_image"
  }
}
```

### Calendar View
```json
{
  "type": "calendar",
  "viewConfig": {
    "dateColumn": "start_date",
    "endDateColumn": "end_date",
    "colorByColumn": "category",
    "viewMode": "month"
  }
}
```

---

## Next Steps

### Immediate (Phase 2.4 - Column Management)
1. Implement view CRUD API endpoints:
   - `GET /api/apps/[appSlug]/tables/[tableSlug]/views` - List views
   - `POST /api/apps/[appSlug]/tables/[tableSlug]/views` - Create view
   - `PUT /api/apps/[appSlug]/tables/[tableSlug]/views/[viewId]` - Update view
   - `DELETE /api/apps/[appSlug]/tables/[tableSlug]/views/[viewId]` - Delete view
   - `GET /api/apps/[appSlug]/tables/[tableSlug]/views/[viewId]/data` - Get filtered/sorted data

2. Build view management UI:
   - View switcher component (tabs/dropdown)
   - "Create View" dialog
   - View settings panel
   - Filter builder UI
   - Sort configuration UI

3. Implement view-aware data fetching:
   - Apply filters to queries
   - Apply sorting
   - Respect column visibility
   - Handle pagination

### Future Enhancements
- View sharing (isPublic flag)
- View templates
- View permissions (who can edit)
- View analytics (usage tracking)
- Saved filters as presets
- View duplication

---

## Testing Checklist

- [ ] Migration runs successfully
- [ ] Default view is created when table is created
- [ ] Column IDs are correctly captured and stored in view
- [ ] View has correct foreign key relationships
- [ ] Database reset includes new table
- [ ] Type exports work correctly
- [ ] No TypeScript errors

---

## Architecture Benefits

### Separation of Concerns
- **Table Structure** (`dataTables`, `dataTableColumns`): What data exists
- **Row Presentation** (`formJson`, `cardJson`, etc.): How individual rows look
- **Data Views** (`dataTableViews`): How to query and display the dataset

### Flexibility
- Users can create unlimited custom views
- Each view can have different filters, sorts, and visible columns
- Support for multiple view types (table, kanban, calendar, etc.)
- Views can be shared or kept private

### Scalability
- Easy to add new view types
- View-specific settings in `viewConfig` JSONB
- No need to modify table structure for new view features

---

## Notes

- **NuxtHub Auto-Export**: The new `dataTableView.ts` schema file is automatically exported via `hub:db:schema` virtual module
- **No Breaking Changes**: Existing table functionality remains unchanged
- **Backward Compatible**: Old tables without views will need migration (future task)
- **Performance**: Consider adding indexes on `dataTableId` and `slug` for faster view lookups

---

**Status**: ✅ Complete  
**Next Phase**: Continue Phase 2.4 - Column Management & Field Types

