# Electric Setup Migration Fix

## ✅ Issue Resolved

**Problem**: Custom SQL migration file was added (`0001_electric_setup.sql`), but migrations should be auto-generated by Drizzle/Nuxt.

**Solution**: Moved Electric publication setup to proper locations.

## What Changed

### ❌ Removed
- `server/db/migrations/postgresql/0001_electric_setup.sql` - Deleted custom migration

### ✅ Added Instead

#### 1. Integrated with Seed Script
**File**: `server/api/seed.post.ts`

Electric publication is now created automatically when you run the seed script:

```bash
pnpm seed
# Or
curl -X POST http://localhost:3001/api/seed
```

This ensures Electric is set up whenever you initialize your database with sample data.

#### 2. Standalone Setup Endpoint
**File**: `server/api/electric/setup.post.ts`

New endpoint specifically for setting up Electric publication:

```bash
# Start dev server
pnpm dev

# Call setup endpoint
curl -X POST http://localhost:3001/api/electric/setup

# Or use npm script
pnpm electric:api-setup
```

#### 3. Docker Auto-Setup (Already Done)
**File**: `docker/init-electric.sh`

Runs automatically when PostgreSQL container starts for the first time.

## Usage Options

### Option 1: Use Seed Script (Recommended)
```bash
pnpm seed
```
This creates test data AND sets up Electric publication.

### Option 2: Use Standalone Endpoint
```bash
# If you don't want to seed data
pnpm dev
curl -X POST http://localhost:3001/api/electric/setup
```

### Option 3: Use Shell Script (Manual)
```bash
pnpm electric:setup
```
The original bash script still works for manual setup.

### Option 4: Docker Init (Automatic)
```bash
pnpm docker:up
```
First-time startup automatically configures Electric.

## Why This Approach?

### ✅ Correct Way
1. **Migrations** = Schema changes (auto-generated by Drizzle)
2. **Seed Scripts** = Initial data + setup (manually written)
3. **API Endpoints** = Runtime operations (manually written)

### ❌ Wrong Way
- Adding custom SQL to migration files
- Mixing schema changes with data/setup

## Updated Workflow

### For New Setup
```bash
# 1. Start Docker (auto-configures PostgreSQL)
pnpm docker:up

# 2. Run migrations (auto-generated)
pnpm db:migrate

# 3. Seed data (includes Electric setup)
pnpm seed

# 4. Start dev server
pnpm dev

# Done! ✅
```

### For Existing Database
```bash
# If you already have data and just need Electric setup
pnpm dev
curl -X POST http://localhost:3001/api/electric/setup
```

## What the Endpoints Do

### `/api/electric/setup`
```typescript
// Creates Electric publication for specified tables
POST /api/electric/setup

// Response:
{
  "success": true,
  "data": {
    "message": "Electric publication created successfully",
    "tables": [
      { "pubname": "electric_publication", "pubtable": "workspaces" }
    ]
  }
}
```

### Updated `/api/seed`
```typescript
// Now includes Electric setup as final step
POST /api/seed

// Response includes:
{
  "success": true,
  "data": {
    "user": { ... },
    "company": { ... },
    "workspace": { ... },
    "electricPublication": "created",  // ← New!
    "message": "Seed data created successfully"
  }
}
```

## Package.json Scripts

Updated scripts:
```json
{
  "electric:setup": "bash scripts/setup-electric.sh",
  "electric:api-setup": "curl -X POST http://localhost:3001/api/electric/setup"
}
```

## Testing

### Test Seed Integration
```bash
# Reset database
pnpm db:drop
pnpm db:migrate

# Seed (should include Electric setup)
pnpm seed

# Verify publication exists
docker exec docpal-postgres psql -U docpal -d docpal -c "\dRp+"
# Should show: electric_publication
```

### Test Standalone Endpoint
```bash
# Drop publication
docker exec docpal-postgres psql -U docpal -d docpal -c "DROP PUBLICATION IF EXISTS electric_publication;"

# Recreate via API
curl -X POST http://localhost:3001/api/electric/setup

# Verify
docker exec docpal-postgres psql -U docpal -d docpal -c "\dRp+"
```

## Summary

| Approach | When to Use | Command |
|----------|-------------|---------|
| **Seed Script** | Initial setup with test data | `pnpm seed` |
| **API Endpoint** | Setup without seeding | `curl -X POST http://localhost:3001/api/electric/setup` |
| **Shell Script** | Manual/troubleshooting | `pnpm electric:setup` |
| **Docker Init** | First-time container startup | `pnpm docker:up` |

## Why No Migration?

**Migrations are for schema changes**:
- Adding/removing tables
- Changing columns
- Adding indexes
- Altering constraints

**Not for**:
- Creating publications (PostgreSQL logical replication)
- Seeding data
- Setting up external integrations
- Granting permissions

Publications are **operational setup**, not schema, so they belong in seed scripts or setup endpoints, not migrations.

This keeps migrations clean and auto-generated by Drizzle! ✅

